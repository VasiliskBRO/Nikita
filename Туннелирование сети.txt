Для создания одного канала между двумя устройствами используют туннель, так как туннелирование требует только указание по какому интерфейсу можно найти соседа и адрес соседа, но обязательно необходим ip адрес, а так как при адресе в той же подсети, что и другой адрес не будет одобрен, поэтому он должен быть обязательно в другой посети, а между двумя устройствами лучше использовать 32 маску для безопасности.
int tun(номер тунеля)
ip add (адрес)(маска)
tunnel source (интерфейс в сторону соседа)
tunnel destination (адрес соседа “не адрес туннеля”)
Такие туннели лучше использовать, чтобы сократить временные расходы и подходит только в локальной сети.
Для туннеля через глобальную сеть необходимо настроить шифрование и установить правила ACL
Для разрешения туннеля между устройствами используется ACL лист разрешающий проход между одним адресом на другой
 ip access-list extended (имя)#2
permit gre host (адрес в сторону соседа) host (адрес соседа)
Для шифрования необходима политика
Приоритетность и номер политики чем ниже тем приоритетней от 1-1000
crypto isakmp policy (номер политики)
Выбор алгоритма шифрование 256, 192, 128, 3des, des (бит)
encr aes (алгоритм шифрования)
Выбор алгоритма хеширования sha512, sha256, sha1, md5
hash (алгоритм хеширования)
Выбор метода аутентификации pre-share по ключам, rsa-sig по сертификатам
authentication (метод аутентификации)
Группа для обмена ключами чем выше, тем более защищенная 24 2048бит, 19 256бит, 20 384бит
group (номер группы)
ex
Далее необходимо создать одинаковые ключи для соседей
crypto isakmp key (ключ) address (адрес соседа)
Далее необходимо настроить время жизни соединения. Интервал 10-30 сек для нестабильных, 30-60 для сек для стабильных, количество попыток 5-3 для быстрого соединения и 5-10 для соединений с потерями пакетов
crypto isakmp keepalive (интервал) (количество попыток)
После можно добавить правило для перебрасывание шифрованного трафика, через туннел
crypto ipsec transform-set (имя правила) esp-aes esp-sha-hmac#1
mode tunnel
Для добавления IPsec шифрования на туннель для получения VPN соединения необходимо создать криптографическую карту
Создать карту, назвать и обозначить приоритет и указать тип обмена ключами ipsec-isakmp или ipsec-manual
crypto map (имя карты) (число приоритета) (тип обмена ключами)
Указать пир в виде адреса соседа
set peer (адрес соседа)
Указать аутентификацию в виде ее имени, созданную ранее
set transform-set (имя аутентификации)#1
Добавить правило для определения какой трафик необходимо для шифрования созданное ранее
match address (имя правила)#2
После для получение VPN соединения между устройствами с шифрованием необходимо ее применить на интерфейс, который используется для туннеля, который можно указать в tunnel source при настройки туннеля.
Int (номер интерфейса)
crypto map (имя карты)
Проверить туннель  можно командой ping 
Ping (адрес туннеля соседа)
А сам IPsec VPN командами
sh crypto isakmp sa
sh crypto ipsec sa
Для участия в динамической маршрутизации данного VPN соединения необходимо либо создать, либо добавить интерфейсы по подсети и ее маски включая туннель
router ospf (номер OSPF)
Network (подсеть) (обратная маска) area (№ зоны)
Включить в маршрутизацию OSPF туннель сделав его активным для маршрутизации
 passive-interface default
no passive-interface Tunnel(номер туннеля)
Также необходимо включить аутентификацию OSPF и указать ключ аутентификации для IPsec VPN соединения.
int tun(номер туннеля)
ip ospf authentication
ip ospf authentication-key (ключ аутентификации)

